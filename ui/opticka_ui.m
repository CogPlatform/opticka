function varargout = opticka_ui(varargin)
% OPTICKA_UI_EXPORT M-file for opticka_ui.fig
%      OPTICKA_UI_EXPORT, by itself, creates a new OPTICKA_UI_EXPORT or raises the existing
%      singleton*.
%
%      H = OPTICKA_UI_EXPORT returns the handle to a new OPTICKA_UI_EXPORT or the handle to
%      the existing singleton*.
%
%      OPTICKA_UI_EXPORT('CALLBACK',hObject,eventData,handles,...) calls the local
%      function named CALLBACK in OPTICKA_UI_EXPORT.M with the given input arguments.
%
%      OPTICKA_UI_EXPORT('Property','Value',...) creates a new OPTICKA_UI_EXPORT or raises the
%      existing singleton*.  Starting from the left, property value pairs are
%      applied to the GUI before opticka_ui_export_OpeningFcn gets called.  An
%      unrecognized property name or invalid value makes property application
%      stop.  All inputs are passed to opticka_ui_export_OpeningFcn via varargin.
%
%      *See GUI Options on GUIDE's Tools menu.  Choose "GUI allows only one
%      instance to run (singleton)".
%
% See also: GUIDE, GUIDATA, GUIHANDLES

% Edit the above text to modify the response to help opticka_ui

% Last Modified by GUIDE v2.5 25-Feb-2015 20:32:16

% Begin initialization code - DO NOT EDIT
gui_Singleton = 1;
gui_State = struct('gui_Name',       mfilename, ...
	'gui_Singleton',  gui_Singleton, ...
	'gui_OpeningFcn', @opticka_ui_OpeningFcn, ...
	'gui_OutputFcn',  @opticka_ui_OutputFcn, ...
	'gui_LayoutFcn',  @opticka_ui_LayoutFcn, ...
	'gui_Callback',   []);
if nargin && ischar(varargin{1})
	gui_State.gui_Callback = str2func(varargin{1});
end

if nargout
	[varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
else
	gui_mainfcn(gui_State, varargin{:});
end
% End initialization code - DO NOT EDIT


% --- Executes just before opticka_ui is made visible.
function opticka_ui_OpeningFcn(hObject, eventdata, handles, varargin)
% This function has no output args, see OutputFcn.
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% varargin   command line arguments to opticka_ui (see VARARGIN)

% Choose default command line output for opticka_ui
handles.output = hObject;

% Update handles structure
guidata(hObject, handles);

% UIWAIT makes opticka_ui wait for user response (see UIRESUME)
% uiwait(handles.OKRoot);


% --- Outputs from this function are returned to the command line.
function varargout = opticka_ui_OutputFcn(hObject, eventdata, handles)
% varargout  cell array for returning output args (see VARARGOUT);
% hObject    handle to figure
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Get default command line output from handles structure
varargout{1} = handles.output;

% --------------------------------------------------------------------
function OKMenuFile_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuFile (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuEdit_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuEdit (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuTools_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuTools (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuStimulusLog_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuStimulusLog (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.task.showLog;
end

% --------------------------------------------------------------------
function OKMenuShowGammaPlots_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuShowGammaPlots (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen.gammaTable,'calibrateLuminance')
		o.r.screen.gammaTable.plot;
	end
end
% --------------------------------------------------------------------
function OKMenuLogs_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuLogs (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuCheckIO_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuCheckIO (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	
end

% --------------------------------------------------------------------
function OKMenuEditConfiguration_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuEditConfiguration (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% --------------------------------------------------------------------
function OKMenuAllTimingLogs_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuAllTimingLogs (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.getRunLog;
end

% --------------------------------------------------------------------
function OKMenusMLogs_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuAllTimingLogs (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if ~isempty(isprop(o.r.stateMachine,'log')) && ~isempty(o.r.stateMachine.log)
		o.r.stateMachine.plotLogs(o.r.stateMachine.log);
	else
		warndlg('No log available yet.')
	end
end

% --------------------------------------------------------------------
function OKMenuMissedFrames_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuMissedFrames (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuCut_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuCut (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuCopy_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuCopy (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKMenuPaste_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuPaste (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% --- Executes on selection change in OKSelectScreen.
function OKSelectScreen_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end


function OKMonitorDistance_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end


function OKpixelsPerCm_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end


function OKscreenXOffset_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKscreenYOffset_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKWindowSize_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKGLSrc_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end


function OKGLDst_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKbitDepth_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKAntiAliasing_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKUseGamma_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKSerialPortName_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

% --- Executes on button press in OKUsePhotoDiode.
function OKUsePhotoDiode_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

% --- Executes on button press in OKuseDataPixx.
function OKuseDataPixx_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseDisplayPP,'Checked','off');
		set(handles.OKuseLabJackStrobe,'Checked','off');
		set(handles.OKuseLabJackTStrobe,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press in OKuseDataPixx.
function OKuseDisplayPP_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');	
	else
		set(hObject,'Checked','on');
		set(handles.OKuseDataPixx,'Checked','off');
		set(handles.OKuseLabJackStrobe,'Checked','off');
		set(handles.OKuseLabJackTStrobe,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press in OKuseLabJack.
function OKuseLabJackStrobe_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseDataPixx,'Checked','off');
		set(handles.OKuseDisplayPP,'Checked','off');
		set(handles.OKuseLabJackTStrobe,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press in OKuseLabJack.
function OKuseLabJackTStrobe_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseDataPixx,'Checked','off');
		set(handles.OKuseDisplayPP,'Checked','off');
		set(handles.OKuseLabJackStrobe,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press in OKuseLabJack.
function OKuseLabJackReward_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseArduino,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press
function OKuseArduino_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseLabJackReward,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press
function OKuseEyeOccluder_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
	end
	o.getScreenVals;
end

% --- Executes on button press 
function OKuseEyeLink_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseTobii,'Checked','off');
	end
	o.getScreenVals;
end

% --- Executes on button press in OKuseEyelink.
function OKuseTobii_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if strcmpi(get(hObject,'Checked'),'on')
		set(hObject,'Checked','off');
	else
		set(hObject,'Checked','on');
		set(handles.OKuseEyelink,'Checked','off');
	end
	o.getScreenVals;
end


% --- Executes on button press in OKVerbose.
function OKVerbose_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

% --- Executes on button press in OKlogFrames.
function OKlogFrames_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen,'screenManager')
		if get(hObject,'Value') == 1
			set(handles.OKbenchmark,'Value',0)
		end
		o.getScreenVals;
	end
end

% --- Executes on button press in OKOpenGLBlending.
function OKOpenGLBlending_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

% --- Executes on button press in OKHideFlash.
function OKHideFlash_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

% --- Executes on button press in OKDebug.
function OKDebug_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKbackgroundColour_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKNativeBeamPosition_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKrecordMovie_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getScreenVals;
end

function OKnBlocks_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

function OKisTime_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

function OKtrialTime_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

function OKrealTime_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

% --------------------------------------------------------------------
function OKMenuNoiseTexture_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuNoiseTexture (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.store.visibleStimulus='dots';
	
end

% --------------------------------------------------------------------
function OKMenuLineTexture_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuLineTexture (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% --------------------------------------------------------------------
function OKMenuTargetInducer_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSpot (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'targetInducerStimulus')
		o.store.targetInducerStimulus=targetInducerStimulus('name','Target-Inducer Stimulus');
	end
	o.store.visibleStimulus = o.store.targetInducerStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuDots_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSpot (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'dotsStimulus')
		o.store.dotsStimulus=dotsStimulus('name', 'Coherent Dots Stimulus',...
			'speed', 2, 'colour', [1 1 1]);
	end
	o.store.dotsStimulus.speed = 2;
	o.store.visibleStimulus = o.store.dotsStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuNDots_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuNDots (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'ndotsStimulus')
		o.store.ndotsStimulus=ndotsStimulus('name','Newsome Dots Stimulus',...
			'speed', 2, 'colour', [1 1 1]);
	end
	o.store.ndotsStimulus.speed = 2;
	o.store.visibleStimulus = o.store.ndotsStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuBar_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuBar (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'barStimulus')
		o.store.barStimulus=barStimulus('name','Bar Stimulus');
	end
	o.store.visibleStimulus = o.store.barStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuGrating_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuGrating (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'gratingStimulus')
		o.store.gratingStimulus=gratingStimulus('name','Grating Stimulus');
	end
	o.store.visibleStimulus = o.store.gratingStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuGabor_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuGabor (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'gaborStimulus')
		o.store.gaborStimulus=gaborStimulus('name','Gabor Stimulus');
	end
	o.store.visibleStimulus = o.store.gaborStimulus;
	set(handles.OKPanelStimulusText,'String','')
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
end

% --------------------------------------------------------------------
function OKMenuSpot_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSpot (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'spotStimulus')
		o.store.spotStimulus=spotStimulus('name','Spot Stimulus');
	end
	o.store.visibleStimulus = o.store.spotStimulus;
	set(handles.OKPanelStimulusText,'String','')
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
end

% --------------------------------------------------------------------
function OKMenuDisc_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuDisc (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'discStimulus')
		o.store.discStimulus=discStimulus('name','Disc Stimulus');
	end
	o.store.visibleStimulus = o.store.discStimulus;
	set(handles.OKPanelStimulusText,'String','')
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
end

% --------------------------------------------------------------------
function OKMenuFixationCross_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSpot (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'fixationCrossStimulus')
		o.store.fixationCrossStimulus=fixationCrossStimulus('name','Fixation Cross');
	end
	o.store.visibleStimulus = o.store.fixationCrossStimulus;
	set(handles.OKPanelStimulusText,'String','')
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
end

% --------------------------------------------------------------------
function OKMenuTexture_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuTexture (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'textureStimulus')
		o.store.textureStimulus=textureStimulus('name','Picture / Texture Stimulus');
	end
	o.store.visibleStimulus = o.store.textureStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end

% --------------------------------------------------------------------
function OKMenuMovie_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuTexture (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.closePanel();
		o.store = rmfield(o.store,'visibleStimulus');
	end
	
	set(handles.OKPanelStimulusText,'String','Loading Stimulus Panel...'); drawnow
	if o.r.stimuli.n == 0;handles.OKStimList.String='Once you''ve edited this stimulus, click [add]';end
	
	if ~isfield(o.store,'movieStimulus')
		o.store.movieStimulus=movieStimulus('name','Movie Stimulus');
	end
	o.store.visibleStimulus = o.store.movieStimulus;
	o.store.visibleStimulus.makePanel(handles.OKPanelStimulus);
	set(handles.OKAddStimulus,'Enable','on');
	set(handles.OKPanelStimulusText,'String','')
end


% --------------------------------------------------------------------
function OKMenuPreferences_Callback(hObject, eventdata, handles)


function OKProtocolsList_Callback(hObject, eventdata, handles)


function OKHistoryList_Callback(hObject, eventdata, handles)


% --- Executes on button press in OKProtocolLoad.
function OKProtocolLoad_Callback(hObject, eventdata, handles)
% hObject    handle to OKProtocolLoad (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('loadProtocol');
end

% --- Executes on button press in OKProtocolSave.
function OKProtocolSave_Callback(hObject, eventdata, handles)
% hObject    handle to OKProtocolSave (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('saveProtocol');
end

% --- Executes on button press in OKProtocolSave.
function OKSaveData_Callback(hObject, eventdata, handles)
% hObject    handle to OKProtocolSave (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('saveData');
end

% --- Executes on button press in OKProtocolDuplicate.
function OKProtocolDuplicate_Callback(hObject, eventdata, handles)
% hObject    handle to OKProtocolDuplicate (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('duplicateProtocol');
end

% --- Executes on button press in OKProtocolDelete.
function OKProtocolDelete_Callback(hObject, eventdata, handles)
% hObject    handle to OKProtocolDelete (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('deleteProtocol');
end

% --------------------------------------------------------------------
function OKMenuCalibrateLuminance_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuCalibrateLuminance (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v=get(handles.OKSelectScreen,'Value');
	inp = struct('screen',v-1);
	if isa(o.r.screen.gammaTable,'calibrateLuminance')
		o.r.screen.gammaTable.run;
	else
		c = calibrateLuminance(inp);
		o.r.screen.gammaTable = c;
		c.filename = [o.paths.calibration filesep 'Cal-' date '-' c.comments];
		o.saveCalibration;
	end
	set(handles.OKUseGamma,'Value',1)
	o.r.screen.gammaTable.choice = 0; 
	set(handles.OKUseGamma,'String',['None'; 'Gamma'; o.r.screen.gammaTable.analysisMethods]);
end

% --------------------------------------------------------------------
function OKMenuLoadGamma_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuLoadGamma (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	uiopen('~/MatlabFiles/Calibration')
	if exist('tmp','var') && isa(tmp,'calibrateLuminance')
		o.r.screen.gammaTable = tmp;
		clear tmp;
		if get(handles.OKUseGamma,'Value') > length(['None'; 'Gamma'; o.r.screen.gammaTable.analysisMethods])
			set(handles.OKUseGamma,'Value',1);
			o.r.screen.gammaTable.choice = 0; 
		else
			o.r.screen.gammaTable.choice = get(handles.OKUseGamma,'Value')-1;
		end
		set(handles.OKUseGamma,'String',['None'; 'Gamma'; o.r.screen.gammaTable.analysisMethods]);
	end
end

% --------------------------------------------------------------------
function OKMenuSaveGamma_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSaveGamma (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen.gammaTable,'calibrateLuminance')
		tmp=o.r.screen.gammaTable;
		uisave('tmp',[o.paths.calibration filesep 'Calibration-' date '-' o.r.screen.gammaTable.comments]);
	end
end

% --------------------------------------------------------------------
function OKMenuClearGamma_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSaveGamma (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen.gammaTable,'calibrateLuminance')
		o.r.screen.gammaTable = calibrateLuminance;
		set(handles.OKUseGamma,'Value',1);
		set(handles.OKUseGamma,'String','None');
	end
end

% --------------------------------------------------------------------
function OKMenuCalibrateSize_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuCalibrateSize (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
v=get(handles.OKSelectScreen,'Value');
s=str2num(get(handles.OKMonitorDistance,'String')); 
[~,dpc]=calibrateSize(v-1,s);
set(handles.OKpixelsPerCm,'String',num2str(dpc));


function OKibTime_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

function OKRandomise_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end
% --- Executes on selection change in OKrandomGenerator.
function OKrandomGenerator_Callback(hObject, eventdata, handles)
% hObject    handle to OKrandomGenerator (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hints: contents = cellstr(get(hObject,'String')) returns OKrandomGenerator contents as cell array
%        contents{get(hObject,'Value')} returns selected item from OKrandomGenerator
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

function OKRandomSeed_Callback(hObject, eventdata, handles)
% hObject    handle to OKRandomSeed (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hints: get(hObject,'String') returns contents of OKRandomSeed as text
%        str2double(get(hObject,'String')) returns contents of OKRandomSeed as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

% --- Executes on button press in OKHistoryUp.
function OKHistoryUp_Callback(hObject, eventdata, handles)
% hObject    handle to OKHistoryUp (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --- Executes on button press in OKHistoryDown.
function OKHistoryDown_Callback(hObject, eventdata, handles)
% hObject    handle to OKHistoryDown (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --- Executes on button press in OKHistoryDelete.
function OKHistoryDelete_Callback(hObject, eventdata, handles)
% hObject    handle to OKHistoryDelete (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --- Executes on selection change in OKVariableList.
function OKVariableList_Callback(hObject, eventdata, handles)
% hObject    handle to OKVariableList (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: contents = cellstr(get(hObject,'String')) returns OKVariableList contents as cell array
%        contents{get(hObject,'Value')} returns selected item from OKVariableList

% --- Executes on button press in OKCopyVariableName.
function OKCopyVariableName_Callback(hObject, eventdata, handles)
% hObject    handle to OKCopyVariableName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
string = get(handles.OKVariableList,'String');
value = get(handles.OKVariableList,'Value');
string=string{value};
set(handles.OKVariableName,'String',string);

function OKCopyVariableNameValues_Callback(hObject, eventdata, handles)
string = get(handles.OKVariableList,'String');
value = get(handles.OKVariableList,'Value');
string=string{value};
set(handles.OKVariableName,'String',string);

switch string
	case 'angle'
		string = num2str(-90:45:90);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'direction'
		string = num2str(-90:45:90);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'phase'
		string = num2str(0:22.5:180);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'size'
		string = num2str([0 0.1 0.2 0.35 0.5 0.75 1 2 4 6 8]);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'contrast'
		string = num2str(0:0.1:1);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'sf'
		string = num2str([0 0.1 0.5 0.7 1 1.5 2 3 4 5 6]);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'tf'
		string = num2str([0.5 1 2 3 4 5]);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);
	case 'xPosition'
		string = num2str(-1:0.2:1);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);	
	case 'yPosition'
		string = num2str(-1:0.2:1);
		string = regexprep(string,'\s+',' '); %collapse spaces
		set(handles.OKVariableValues,'String',string);	
	case 'xyPosition'
		string = '{[-5 -5],[0 0], [5 5]}';
		set(handles.OKVariableValues,'String',string);	
	case 'colour'
		string = '{[1 0 0],[0 1 0],[0 0 1]}';
		set(handles.OKVariableValues,'String',string);	
end


% --- Executes on button press in OKVariablesLinear.
function OKVariablesLinear_Callback(hObject, eventdata, handles)
values = str2num(get(handles.OKVariableValues,'String'));
if length(values) == 3
	values=linspace(values(1),values(2),values(3));
	string = num2str(values);
else
	string = num2str(values);
	string = regexprep(string,'\s+',' '); %collapse spaces
end
set(handles.OKVariableValues,'String',string);

% --- Executes on button press in OKVariablesLog.
function OKVariablesLog_Callback(hObject, eventdata, handles) %#ok<*INUSD>
values = str2num(get(handles.OKVariableValues,'String'));
if length(values) == 3
	values=logspace(log10(values(1)),log10(values(2)),values(3));
	string = num2str(values);
	string = regexprep(string,'\s+',' '); %collapse spaces
	set(handles.OKVariableValues,'String',string);
else
	warndlg('Please enter a minimum, maximum and number of values');
end

% --- Executes on button press in OKAddStimulus.
function OKAddStimulus_Callback(hObject, eventdata, handles)
% hObject    handle to OKAddStimulus (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isfield(o.store,'visibleStimulus')
		o.store.visibleStimulus.readPanel();
		o.r.stimuli{o.r.stimuli.n+1} = o.store.visibleStimulus.clone();
		%o.r.stimuli{o.r.stimuli.n}.name = 'Stimulus';
		o.addStimulus;
		if o.r.stimuli.n > 0
			set(handles.OKAddStimulus,'Enable','on');
			set(handles.OKDeleteStimulus,'Enable','on');
			set(handles.OKModifyStimulus,'Enable','on');
			set(handles.OKCopyStimulus,'Enable','on');
			set(handles.OKStimulusUp,'Enable','on');
			set(handles.OKStimulusDown,'Enable','on');
			set(handles.OKStimulusRun,'Enable','on');
			set(handles.OKStimulusRunBenchmark,'Enable','on');
			set(handles.OKStimulusRunAll,'Enable','on');
			set(handles.OKStimulusRunAllBenchmark,'Enable','on');
			set(handles.OKStimulusRunSingle,'Enable','on');
		end
	end
end

% --- Executes on button press in OKDeleteStimulus.
function OKDeleteStimulus_Callback(hObject, eventdata, handles)
% hObject    handle to OKDeleteStimulus (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.deleteStimulus;
	if o.r.stimuli.n == 0
		set(handles.OKAddStimulus,'Enable','off');
		set(handles.OKDeleteStimulus,'Enable','off');
		set(handles.OKModifyStimulus,'Enable','off');
		set(handles.OKCopyStimulus,'Enable','off');
		set(handles.OKStimulusUp,'Enable','off');
		set(handles.OKStimulusDown,'Enable','off');
		set(handles.OKStimulusRun,'Enable','off');
		set(handles.OKStimulusRunBenchmark,'Enable','off');
		set(handles.OKStimulusRunAll,'Enable','off');
		set(handles.OKStimulusRunAllBenchmark,'Enable','off');
		set(handles.OKStimulusRunSingle,'Enable','off');
	end
end

% --- Executes on button press in OKCopyStimulus.
function OKCopyStimulus_Callback(hObject, eventdata, handles)
% hObject    handle to OKCopyStimulus (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKStimList,'Value');
	o.r.stimuli{o.r.stimuli.n+1} = o.r.stimuli{v}.clone;
	o.r.stimuli{o.r.stimuli.n}.name = ['Stimulus #' num2str(o.r.stimuli.n)];
	o.addStimulus;
end

% --- Executes on selection change in OKStimList.
function OKStimList_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.editStimulus;
end

% --- Executes on button press in OKStimulusDown.
function OKStimulusDown_Callback(hObject, eventdata, handles) %#ok<*INUSL>
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	value = get(handles.OKStimList,'Value'); %where are we in the stimulus list
	slength = o.r.stimuli.n;
	if value < slength
		idx = 1:slength;
		idx2 = idx;
		idx2(value) = idx2(value)+1;
		idx2(value+1) = idx2(value+1)-1;
		o.r.stimuli(idx) = o.r.stimuli(idx2);
		set(handles.OKStimList,'Value',value+1);
		o.modifyStimulus;
	end
end

% --- Executes on button press in OKStimulusUp.
function OKStimulusUp_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	value = get(handles.OKStimList,'Value'); %where are we in the stimulus list
	slength = o.r.stimuli.n;
	if value > 1
		idx = 1:slength;
		idx2 = idx;
		idx2(value) = idx2(value)-1;
		idx2(value-1) = idx2(value-1)+1;
		o.r.stimuli(idx) = o.r.stimuli(idx2);
		set(handles.OKStimList,'Value',value-1);
		o.modifyStimulus;
	end
end

% --- Executes on button press in OKStimulusRun.
function OKStimulusRun_Callback(hObject, eventdata, handles)
% hObject    handle to OKStimulusRun (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKStimList,'Value');
	if v > 0 && isobject(o.r.stimuli{v})
		trialTime = str2num(get(handles.OKtrialTime,'String'));
		if IsWin
			forceScreen = 1;
		else
			forceScreen = 0;
		end
		if isa(o.r.screen,'screenManager') && ~isempty(o.r.screen)
			run(o.r.stimuli{v}, false, trialTime, o.r.screen, forceScreen);
		else
			run(o.r.stimuli{v}, false, trialTime, [], forceScreen);
		end
	end
	set(handles.OKStimulusRunAll,'Enable','on');
end

% --- Executes on button press in OKStimulusRunBenchmark.
function OKStimulusRunBenchmark_Callback(hObject, eventdata, handles)
% hObject    handle to OKStimulusRunBenchmark (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKStimList,'Value');
	if v > 0 && isa(o.r.stimuli{v},'baseStimulus')
		if isa(o.r.screen,'screenManager')
			run(o.r.stimuli{v}, true, 5, o.r.screen);
		else
			run(o.r.stimuli{v}, true, 5);
		end
	end
end

% --- Executes on button press in OKStimulusRunAll.
function OKStimulusRunAll_Callback(hObject, eventdata, handles)
% hObject    handle to OKStimulusRunAll (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.stimuli,'metaStimulus') && o.r.stimuli.n > 0
		trialTime = str2num(get(handles.OKtrialTime,'String'));
		o.r.stimuli.choice = [];
		if isa(o.r.screen,'screenManager') && ~isempty(o.r.screen)
			run(o.r.stimuli, false, trialTime, o.r.screen);
		else
			run(o.r.stimuli, false, trialTime, []);
		end
	end
end

% --- Executes on button press in OKStimulusRunAllBenchmark.
function OKStimulusRunAllBenchmark_Callback(hObject, eventdata, handles)
% hObject    handle to OKStimulusRunAllBenchmark (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.stimuli,'metaStimulus') && o.r.stimuli.n > 0
		o.r.stimuli.choice = [];
		if isa(o.r.screen,'screenManager')
			run(o.r.stimuli, true, 5, o.r.screen);
		else
			run(o.r.stimuli, true, 5);
		end
	end
end

% --- Executes on button press in OKStimulusRunSingle.
function OKStimulusRunSingle_Callback(hObject, eventdata, handles)
% hObject    handle to OKStimulusRunSingle (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.stimuli,'metaStimulus') && o.r.stimuli.n > 0
		o.r.stimuli.choice = [];
		if isa(o.r.screen,'screenManager')
			runSingle(o.r.stimuli, o.r.screen);
		else
			runSingle(o.r.stimuli, o.r.screen);
		end
	end
end


% --- Executes on button press in OKInspectStimulus.
function OKInspectStimulus_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKStimList,'Value');
	if v > 0
		uiinspect(o.r.stimuli{v});
	end
end

% --- Executes on button press in OKInspectVariable.
function OKInspectVariable_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKVarList,'Value');
	if v > 0
		uiinspect(o.r.task.nVar(v));
	end
end


% --- Executes on button press in OKModifyStimulus.
function OKModifyStimulus_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	v = get(handles.OKStimList,'Value');
	if v > 0
		seditor(o.r.stimuli{v}, handles.output);
	end
	
end

% --- Executes on button press in OKAddVariable.
function OKAddVariable_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.addVariable;
	if o.r.task.nVars > 0
		set(handles.OKDeleteVariable,'Enable','on');
		set(handles.OKCopyVariable,'Enable','on');
		set(handles.OKEditVariable,'Enable','on');
	end
end

% --- Executes on button press in OKDeleteVariable.
function OKDeleteVariable_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.deleteVariable;
	if o.r.task.nVars < 1
		set(handles.OKDeleteVariable,'Enable','off');
		set(handles.OKCopyVariable,'Enable','off');
		set(handles.OKEditVariable,'Enable','off');
	end
end

function OKCopyVariable_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.copyVariable;
end

function OKEditVariable_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.editVariable;
end

function OKVariableOffset_Callback(hObject, eventdata, handles)
% hObject    handle to OKVariableOffset (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKVariableOffset as text
%        str2double(get(hObject,'String')) returns contents of OKVariableOffset
%        as a double

% --------------------------------------------------------------------
function OKToolbarRun_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarRun (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if o.r.isRunning == true;return;end
	if ~isempty(o.oc) && o.oc.isOpen == 1 && o.r.useLabJack == 1
		o.oc.write('--GO!--');
		pause(0.5);
	end
	drawnow;
	o.r.uiCommand='run';
	o.r.run;
end

% --------------------------------------------------------------------
function OKToolbarStop_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarStop (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.uiCommand='stop';
	drawnow;
end

% --------------------------------------------------------------------
function OKToolbarAbort_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarAbort (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.uiCommand='abort';
	if isa(o.oc,'dataConnection')
		o.oc.write('--abort--');
	end
	drawnow;
end

function OKRemoteIP_Callback(hObject, eventdata, handles)
% hObject    handle to OKRemoteIP (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKRemoteIP as text
%        str2double(get(hObject,'String')) returns contents of OKRemoteIP as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end


function OKRemotePort_Callback(hObject, eventdata, handles)
% hObject    handle to OKRemotePort (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKRemotePort as text
%        str2double(get(hObject,'String')) returns contents of OKRemotePort as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getTaskVals;
end

% --------------------------------------------------------------------
function OKToolbarToggleRemote_OnCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarToggleRemote (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	eval(o.store.serverCommand)
end


% --------------------------------------------------------------------
function OKMenumanageCode_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenumanageCode (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
manageCode


% --------------------------------------------------------------------
function OKMenurfMapperLog_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenurfMapperLog (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


function OKSettingsmovieSize_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.screen.movieSettings.size=str2num(get(hObject,'String'));
end

function OKSettingsmovieFrames_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.screen.movieSettings.nFrames=str2num(get(hObject,'String')); %#ok<*ST2NM>
end

function OKSettingsmoviePrecision_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.screen.movieSettings.quality=get(hObject,'Value');
end

function OKSettingsmovieType_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.screen.movieSettings.type=get(hObject,'Value');
end

function OKSettingsmovieCodec_Callback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.screen.movieSettings.codec=get(hObject,'String');
end

% --------------------------------------------------------------------
function OKPanelTellOmniplex_ClickedCallback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	resp = questdlg('Is opxOnline running on the Omniplex machine?','Check OPX','No');
	if strcmpi(resp,'Yes')
		o.connectToOmniplex
	end
end

% --------------------------------------------------------------------
function OKPanelReconnectOmniplex_ClickedCallback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.oc,'dataConnection')
		o.oc.closeAll;
		o.connectToOmniplex;
	end
end

% --------------------------------------------------------------------
function OKPanelSendOmniplex_ClickedCallback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.oc,'dataConnection')
		o.sendOmniplexStimulus;
	end
end

% --------------------------------------------------------------------
function OKPanelDisconnectOmniplex_ClickedCallback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.oc,'dataConnection')
		o.disconnectOmniplex;
	end
end

% --------------------------------------------------------------------
function OKPanelPingOmniplex_ClickedCallback(hObject, eventdata, handles)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	rAddress = get(handles.OKOmniplexIP,'String');
	status = o.ping(rAddress);
	if status > 0
		set(o.h.OKOmniplexStatus,'String','Omniplex: machine ping ERROR!')
	else
		if isa(o.oc,'dataConnection') && o.oc.isOpen == 1
			o.oc.write('--ping--');
			loop = 1;
			while loop < 8
				in = o.oc.read(0);
				fprintf('\n{opticka said: %s}\n',in)
				if regexpi(in,'ping')
					fprintf('\nWe can ping omniplex master on try: %d\n',loop)
					set(handles.OKOmniplexStatus,'String','Omniplex: connected and pinged')
					break
				else
					fprintf('\nOmniplex master not responding, try: %d\n',loop)
					set(handles.OKOmniplexStatus,'String','Omniplex: not responding')
				end
				loop=loop+1;
				pause(0.1);
			end
		end
	end
end


function OKverbosityLevel_Callback(hObject, eventdata, handles)
% hObject    handle to OKverbosityLevel (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKverbosityLevel as text
%        str2double(get(hObject,'String')) returns contents of OKverbosityLevel as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen,'screenManager')
		o.r.screen.verbosityLevel = str2double(get(hObject,'String'));
	end
end


% --- Executes on button press in OKbenchmark.
function OKbenchmark_Callback(hObject, eventdata, handles)
% hObject    handle to OKbenchmark (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hint: get(hObject,'Value') returns toggle state of OKbenchmark
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if isa(o.r.screen,'screenManager')
		if get(hObject,'Value') == 1
			set(handles.OKlogFrames,'Value',0)
		end
		o.getScreenVals;
	end
end

% --- Executes on button press in OKOmniplexEnable.
function OKOmniplexEnable_Callback(hObject, eventdata, handles)
% hObject    handle to OKOmniplexEnable (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
% Hint: get(hObject,'Value') returns toggle state of OKOmniplexEnable
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if get(hObject,'Value') < 1
		set(handles.OKOmniplexIP,'Enable','off');
		set(handles.OKOmniplexPort,'Enable','off');
		set(handles.OKToolbarTellOmniplex,'Enable','off');
		set(handles.OKPanelReconnectOmniplex,'Enable','off');
		set(handles.OKPanelSendOmniplex,'Enable','off');
		set(handles.OKPanelPingOmniplex,'Enable','off');
		set(handles.OKPanelDisconnectOmniplex,'Enable','off');
		set(handles.OKOmniplexStatus,'Enable','off');
	else
		set(handles.OKOmniplexIP,'Enable','on');
		set(handles.OKOmniplexPort,'Enable','on');
		set(handles.OKToolbarTellOmniplex,'Enable','on');
		set(handles.OKPanelReconnectOmniplex,'Enable','on');
		set(handles.OKPanelSendOmniplex,'Enable','on');
		set(handles.OKPanelPingOmniplex,'Enable','on');
		set(handles.OKPanelDisconnectOmniplex,'Enable','on');
		set(handles.OKOmniplexStatus,'Enable','on');
	end
end

% --------------------------------------------------------------------
function OKMenuOpen_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuOpen (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('loadProtocol',false);
end

% --------------------------------------------------------------------
function OKMenuSave_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuSave (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('saveProtocol');
end

% --------------------------------------------------------------------
function OKMenuQuit_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuQuit (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if ~isempty(handles) && isappdata(handles.output,'o')
	try
		o = getappdata(handles.output,'o');
		o.savePrefs;
		rmappdata(handles.output,'o');
		clear o;
	catch ME
		getReport(ME)
		fprintf('!!!>>> Opticka failed to clear all data on close...\n');
	end
end
try; warning off; close(gcf); warning on; end

% --------------------------------------------------------------------
function OKMenuNewProtocol_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuNewProtocol (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r = [];
	o.store.evnt = [];
	o.store = rmfield(o.store,'evnt');
	o.store.visibleStimulus=[];
	o.store = rmfield(o.store,'visibleStimulus');
	o.clearStimulusList;
	o.clearVariableList;
	o.getScreenVals;
	o.getTaskVals;
end

% --------------------------------------------------------------------
function OKToolbarInitialise_ClickedCallback(hObject, eventdata, handles) %#ok<*DEFNU>
% hObject    handle to OKToolbarInitialise (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r = [];
	o.store.evnt = [];
	o.store = rmfield(o.store,'evnt');
	o.store.visibleStimulus=[];
	o.store = rmfield(o.store,'visibleStimulus');
	o.clearStimulusList;
	o.clearVariableList;
	o.getScreenVals;
	o.getTaskVals;
end

% --------------------------------------------------------------------
function OKToolbarOpen_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarOpen (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('loadProtocol','1');
end

% --------------------------------------------------------------------
function OKToolbarDefinePath_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToolbarDefinePath (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	path = uigetdir;
	if ischar(path) && exist(path,'dir')
		initialiseSave(o, path);
		if isa(o.r,'runExperiment');
			initialiseSave(o.r, path);
		end
	end
end


function OKTrainingName_Callback(hObject, eventdata, handles)
% hObject    handle to OKTrainingName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKTrainingName as text
%        str2double(get(hObject,'String')) returns contents of OKTrainingName as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.subjectName = hObject.String;
end

% --- Executes during object creation, after setting all properties.
function OKTrainingName_CreateFcn(hObject, eventdata, handles)
% hObject    handle to OKTrainingName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    empty - handles not created until after all CreateFcns called

% Hint: edit controls usually have a white background on Windows.
%       See ISPC and COMPUTER.
if ispc && isequal(get(hObject,'BackgroundColor'), get(0,'defaultUicontrolBackgroundColor'))
    set(hObject,'BackgroundColor','white');
end


% --------------------------------------------------------------------
function OKToggleUI_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKToggleUI (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if strcmp(get(handles.OKPanelGlobal,'Visible'),'on')
	
	set(handles.OKPanelGlobal,'Visible','off');
	set(handles.OKPanelProtocols,'Visible','on');
	set(handles.OKPanelTraining,'Visible','off');
	
elseif strcmp(get(handles.OKPanelProtocols,'Visible'),'on')
	
	set(handles.OKPanelProtocols,'Visible','off')
	set(handles.OKPanelGlobal,'Visible','off')
	set(handles.OKPanelTraining,'Visible','on')
	if isappdata(handles.output,'o')
		o = getappdata(handles.output,'o');
		o.getStateInfo();
	end
	
else
	
	set(handles.OKPanelProtocols,'Visible','off')
	set(handles.OKPanelGlobal,'Visible','on')
	set(handles.OKPanelTraining,'Visible','off')
	
end

% --- Executes on button press in OKEditStateFileButon.
function OKEditStateFileButon_Callback(hObject, eventdata, handles)
% hObject    handle to OKEditStateFileButon (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if exist(o.r.paths.stateInfoFile,'file')
		edit(o.r.paths.stateInfoFile);
	end
	o.getStateInfo();
end

function OKTrainingResearcherName_Callback(hObject, eventdata, handles)
% hObject    handle to OKTrainingResearcherName (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% Hints: get(hObject,'String') returns contents of OKTrainingResearcherName as text
%        str2double(get(hObject,'String')) returns contents of OKTrainingResearcherName as a double
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.r.researcherName = hObject.String;
end
% --------------------------------------------------------------------
function OKMenuStateInfo_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuStateInfo (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('LoadStateInfo');
	o.getStateInfo();
end

% --- Executes on button press in OKLoadStateButton.
function OKLoadStateButton_Callback(hObject, eventdata, handles)
% hObject    handle to OKLoadStateButton (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.router('LoadStateInfo');
	o.getStateInfo();
end

% --- Executes on button press in OKRefreshStateInfo.
function OKRefreshStateInfo_Callback(hObject, eventdata, handles)
% hObject    handle to OKRefreshStateInfo (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.getStateInfo();
end

% --------------------------------------------------------------------
function OKRFMapper_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKRFMapper (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.store.rfLog = [];
	rf=rfMapper;
	rf.run(o.r);
	o.store.rfLog = rf;
	clear rf;
end

% --------------------------------------------------------------------
function OKRunRFMapper_Callback(hObject, eventdata, handles)
% hObject    handle to OKRunRFMapper (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	o.store.rfLog = [];
	rf=rfMapper;
	rf.run(o.r);
	o.store.rfLog = rf;
	clear rf;
end

% --------------------------------------------------------------------
function OKRunTrainingSession_Callback(hObject, eventdata, handles)
% hObject    handle to OKRunTrainingSession (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --------------------------------------------------------------------
function OKRunExperiment_Callback(hObject, eventdata, handles)
% hObject    handle to OKRunExperiment (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)

% --------------------------------------------------------------------
function OKStartTask_ClickedCallback(hObject, eventdata, handles)
% hObject    handle to OKStartTask (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)
if isappdata(handles.output,'o')
	o = getappdata(handles.output,'o');
	if o.r.checkScreenError()
		fprintf('>>> A previous task did not finish properly, resetting!\n')
	end
	if isa(o.r,'runExperiment') && ~o.r.isRunning
        o.getScreenVals;
		%o.r.screenSettings.optickahandle = handles.output;
		initialiseSaveFile(o.r, o.paths.savedData)
		if ~isempty(regexp(o.comment, '^Protocol','once'))
			o.r.comment = o.comment;
		end
		runTask(o.r);
	end
end


% --------------------------------------------------------------------
function OKMenuIO_Callback(hObject, eventdata, handles)
% hObject    handle to OKMenuIO (see GCBO)
% eventdata  reserved - to be defined in a future version of MATLAB
% handles    structure with handles and user data (see GUIDATA)


% --- Creates and returns a handle to the GUI figure. 
function h1 = opticka_ui_LayoutFcn(policy)
% policy - create a new figure or use a singleton. 'new' or 'reuse'.

persistent hsingleton;
if strcmpi(policy, 'reuse') & ishandle(hsingleton)
    h1 = hsingleton;
    return;
end
load opticka_ui.mat

if ismac
	nfont = 'Source Sans 3';
	mfont = 'menlo';
elseif ispc
	nfont = 'Calibri';
	mfont = 'Consolas';
else %linux
	if system('fc-list -q "Liberation Sans" family') == 0
		nfont = 'Liberation sans'; %get(0,'defaultAxesFontName');
	else
		nfont = 'Source Sans 3';
	end
	if system('fc-list -q "Fira Code" family') == 0
		mfont = 'Fira Code';
	else
		mfont = 'Liberation Mono';
	end
end
ssize = 9;
msize = 11;
lsize = 12;
bcolour = [0.9 0.9 0.9];


appdata.GUIDEOptions = struct(...
    'active_h', [], ...
    'taginfo', struct(...
    'figure', 2, ...
    'text', 217, ...
    'uipanel', 54, ...
    'listbox', 6, ...
    'edit', 181, ...
    'pushbutton', 59, ...
    'popupmenu', 20, ...
    'radiobutton', 4, ...
    'checkbox', 44, ...
    'axes', 6, ...
    'togglebutton', 4, ...
    'uitoolbar', 2, ...
    'uitoggletool', 3, ...
    'uipushtool', 20), ...
    'override', 1, ...
    'release', 13, ...
    'resize', 'simple', ...
    'accessibility', 'callback', ...
    'mfile', 1, ...
    'callbacks', 1, ...
    'singleton', 1, ...
    'syscolorfig', 0, ...
    'blocking', 0, ...
    'lastFilename', '/Users/ian/Code/opticka/ui/opticka_ui.fig', ...
    'lastSavedFile', '/Users/ian/Code/opticka/ui/opticka_ui.m');
appdata.SavedVisible = 'on';
appdata.GUIDELayoutEditor = [];
appdata.initTags = struct(...
    'handle', [], ...
    'tag', 'OKRoot');

h1 = figure(...
'PaperUnits','centimeters',...
'Units',get(0,'defaultfigureUnits'),...
'Position',[100 100 1400 750],...
'Visible','on',...
'Color',bcolour,...
'IntegerHandle','off',...
'DoubleBuffer','off',...
'MenuBar','none',...
'ToolBar','none',...
'Name','Opticka',...
'NumberTitle','off',...
'DockControls','off',...
'PaperPosition',[0 0 29.7 21.0],...
'PaperSize',[29.7 21.0],...
'PaperType','a4',...
'InvertHardcopy',get(0,'defaultfigureInvertHardcopy'),...
'PaperOrientation','landscape',...
'HandleVisibility','callback',...
'CloseRequestFcn',@(hObject,eventdata)opticka_ui('OKMenuQuit_Callback',hObject,eventdata,guidata(hObject)),...
'Tag','OKRoot',...
'UserData',[]);


h146 = uibuttongroup(...
'Parent',h1,...
'FontUnits','pixels',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'TitlePosition','lefttop',...
'Title','Stimuli & Variables',...
'Position',[0 0 1 0.72],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelIndividual',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

if verLessThan('matlab','8.4');tp='top';else;tp='right';end
tabgp = uitabgroup(h1,'Position',[0 0.72 1 0.28],'TabLocation',tp,'Tag','OKtabgp');
tab1 = uitab(tabgp,'Title','Display','Tag','OKtab1','ForegroundColor',[0.75 0.1 0.1]);
tab2 = uitab(tabgp,'Title','Task','Tag','OKtab2','ForegroundColor',[0.75 0.1 0.1]);
tab3 = uitab(tabgp,'Title','Options','Tag','OKtab3','ForegroundColor',[0.75 0.1 0.1]);
%tab4 = uitab(tabgp,'Title','Settings','Tag','OKtab4');

h2 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuFile_Callback',hObject,eventdata,guidata(hObject)),...
'Label','File',...
'Tag','OKMenuFile');

h3 = uimenu(...
'Parent',h2,...
'Accelerator','N',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuNewProtocol_Callback',hObject,eventdata,guidata(hObject)),...
'Label','New Protocol',...
'Tag','OKMenuNewProtocol');

h4 = uimenu(...
'Parent',h2,...
'Accelerator','O',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuOpen_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Open Protocol...',...
'Tag','OKMenuOpen');

h5 = uimenu(...
'Parent',h2,...
'Accelerator','V',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuSave_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Save as Protocol...',...
'Tag','OKMenuSave');

h5b = uimenu(...
'Parent',h2,...
'Accelerator','S',...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKSaveData_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Save as Data...',...
'Tag','OKMenuSave');

h6 = uimenu(...
'Parent',h2,...
'Separator','on',...
'Accelerator','I',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuStateInfo_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Open stateMachine info...',...
'Tag','OKMenuStateInfo');

h7 = uimenu(...
'Parent',h2,...
'Separator','on',...
'Accelerator','X',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuQuit_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Quit Opticka',...
'Tag','OKMenuQuit');

h8 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuEdit_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Edit',...
'Tag','OKMenuEdit');

h9 = uimenu(...
'Parent',h8,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuCut_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Cut',...
'Tag','OKMenuCut');

h10 = uimenu(...
'Parent',h8,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuCopy_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Copy',...
'Tag','OKMenuCopy');

h11 = uimenu(...
'Parent',h8,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuPaste_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Paste',...
'Tag','OKMenuPaste');

h12 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuTools_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Stimulus',...
'Tag','OKMenuTools');

h13 = uimenu(...
'Parent',h12,...
'Accelerator','G',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuGrating_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Grating',...
'Tag','OKMenuGrating');

h14 = uimenu(...
'Parent',h12,...
'Accelerator','R',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuGabor_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Gabor',...
'Tag','OKMenuGabor');

h15 = uimenu(...
'Parent',h12,...
'Accelerator','B',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuBar_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Bar',...
'Tag','OKMenuBar');

h16 = uimenu(...
'Parent',h12,...
'Accelerator','D',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuDots_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Coherent Dots',...
'Tag','OKMenuDots');

h17 = uimenu(...
'Parent',h12,...
'Accelerator','Q',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuNDots_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Newsome Dots',...
'Tag','OKMenuNDots');

h18a = uimenu(...
'Parent',h12,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuFixationCross_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Fixation Cross',...
'Tag','OKMenuSpot');

h18 = uimenu(...
'Parent',h12,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuSpot_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Spot',...
'Tag','OKMenuSpot');

h18b = uimenu(...
'Parent',h12,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuDisc_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Smoothed Disc',...
'Tag','OKMenuDisc');

h19 = uimenu(...
'Parent',h12,...
'Accelerator','T',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuTexture_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Picture',...
'Tag','OKMenuTexture');

h19b = uimenu(...
'Parent',h12,...
'Accelerator','K',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuMovie_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Movie',...
'Tag','OKMenuMovie');

h20 = uimenu(...
'Parent',h12,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuTargetInducer_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Target Inducer',...
'Tag','OKMenuTargetInducer');

h21 = uimenu(...
'Parent',h12,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuPlaid_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Plaid',...
'Separator','on',...
'Tag','OKMenuPlaid');

h22 = uimenu(...
'Parent',h12,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuNoiseTexture_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Noise Texture',...
'Tag','OKMenuNoiseTexture');

h23 = uimenu(...
'Parent',h12,...
'Enable','off',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuLineTexture_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Line Texture',...
'Tag','OKMenuLineTexture');

h24 = uimenu(...
'Parent',h12,...
'Enable','off',...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuRevCorr_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Reverse Correlation',...
'Tag','OKMenuRevCorr');

h25a = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuTools_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Run',...
'Tag','OKMenuRun');

h26 = uimenu(...
'Parent',h25a,...
'Accelerator','1',...
'Callback',@(hObject,eventdata)opticka_ui('OKStartTask_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Label','Run Behavioural task',...
'Tag','OKRunTrainingSession');

h27 = uimenu(...
'Parent',h25a,...
'Accelerator','2',...
'Callback',@(hObject,eventdata)opticka_ui('OKToolbarRun_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Label','Run MOC Task',...
'Tag','OKRunExperiment');

h25 = uimenu(...
'Parent',h25a,...
'Separator','on',...
'Accelerator','3',...
'Callback',@(hObject,eventdata)opticka_ui('OKRunRFMapper_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Run RF Mapper',...
'Tag','OKRunRFMapper'); %#ok<*NASGU>

h57 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuIO_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Input Output',...
'Tag','OKMenuIO');

h58 = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseEyeLink_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','on',...
'Label','Use Eyelink eyetracker',...
'Tag','OKuseEyelink');

h58b = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseTobii_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Use Tobii eyetracker',...
'Tag','OKuseTobii');

h59 = uimenu(...
'Parent',h57,...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKuseDataPixx_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Enable DataPixx for Strobe',...
'Tag','OKuseDataPixx');

h59b = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseDisplayPP_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Enable Display++ for Strobe',...
'Tag','OKuseDisplayPP');

h60 = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseLabJackTStrobe_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Enable LabJack T4 for Strobe',...
'Tag','OKuseLabJackTStrobe');

h60d = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseLabJackStrobe_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Enable LabJack U3/U6 for Strobe',...
'Tag','OKuseLabJackStrobe');

h60a = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseLabJackReward_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Separator','on',...
'Label','Use LabJack for Reward',...
'Tag','OKuseLabJackReward');

h60b = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseArduino_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Label','Use Arduino for Reward',...
'Tag','OKuseArduino');

h60c = uimenu(...
'Parent',h57,...
'Callback',@(hObject,eventdata)opticka_ui('OKuseEyeOccluder_Callback',hObject,eventdata,guidata(hObject)),...
'Checked','off',...
'Separator','on',...
'Label','Use Eye Occluder',...
'Tag','OKuseEyeOccluder');

h28 = uibuttongroup(...
'Parent',tab3,...
'FontUnits','pixels',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'BorderType','none',...
'Title','',...
'Position',[0 0 1 1],...
'Visible','on',...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelProtocols',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

h30 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Protocols',...
'Style','text',...
'Position',[0 0.88 0.06 0.12],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.3 0.3 0.3],...
'Tag','text96',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

h31 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','History',...
'Style','text',...
'Position',[0.287 0.88 0.05 0.12],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.3 0.3 0.3],...
'Enable','off',...
'Tag','text97',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

h32 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Load Protocol',...
'Position',[0 0.7 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKProtocolLoad_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKProtocolLoad',...
'FontSize',msize,...
'FontName',nfont);

h33 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Save As...',...
'Position',[0 0.55 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKProtocolSave_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKProtocolSave',...
'FontSize',msize,...
'FontName',nfont);

h34 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Duplicate Protocol',...
'Position',[0 0.4 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKProtocolDuplicate_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKProtocolDuplicate',...
'FontSize',msize,...
'FontName',nfont);

h35 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Delete...',...
'Position',[0 0.25 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKProtocolDelete_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKProtocolDelete',...
'FontSize',msize,...
'FontName',nfont);

h36 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Move Up',...
'Position',[0.287 0.7 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKHistoryUp_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKHistoryUp',...
'FontSize',ssize,...
'FontName',nfont);

h37 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Move Down',...
'Position',[0.287 0.55 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKHistoryDown_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKHistoryDown',...
'FontSize',ssize,...
'FontName',nfont);

h38 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Delete',...
'Position',[0.287 0.4 0.08 0.14],...
'Callback',@(hObject,eventdata)opticka_ui('OKHistoryDelete_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKHistoryDelete',...
'FontSize',ssize,...
'FontName',nfont);

h39 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'X Y Grating'; 'Patch Tuning'; 'Plaid'; 'Reverse Correlation' },...
'Style','listbox',...
'Value',1,...
'Position',[0.09 0.05 0.19 0.95],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKProtocolsList_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKProtocolsList',...
'FontSize',msize,...
'FontName',nfont);

h29 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'Listbox' },...
'Style','listbox',...
'Value',1,...
'Position',[0.38 0.05 0.19 0.95],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKHistoryList_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKHistoryList',...
'FontSize',msize,...
'FontName',nfont);

h40 = uipanel(...
'Parent',h28,...
'FontUnits','pixels',...
'Title',blanks(0),...
'Position',[0.284 0 0.005 1],...
'Clipping','off',...
'Tag','uipanel35',...
'FontSize',ssize,...
'FontName',nfont );

h41 = uipanel(...
'Parent',h28,...
'FontUnits','pixels',...
'Title',blanks(0),...
'Position',[0.574 0 0.005 1],...
'Clipping','off',...
'Tag','uipanel41',...
'FontSize',ssize,...
'FontName',nfont);


h42 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Settings',...
'Style','text',...
'Position',[0.58 0.88 0.05 0.12],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.3 0.3 0.3],...
'Tag','text181',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

h43 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','400 400',...
'Style','edit',...
'Position',[0.58 0.76 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKSettingsmovieSize_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKSettingsmovieSize',...
'UserData',[],...
'FontSize',msize,...
'FontName',mfont);

h44 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','100',...
'Style','edit',...
'Position',[0.58 0.6 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKSettingsmovieFrames_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKSettingsmovieFrames',...
'UserData',[],...
'FontSize',msize,...
'FontName',mfont);

h45 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Movie High Precision',...
'Style','checkbox',...
'Position',[0.58 0.28 0.1 0.13],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKSettingsmoviePrecision_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKSettingsmoviePrecision',...
'FontSize',ssize,...
'FontName',nfont);

h46 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Movie Size (px)',...
'Style','text',...
'Position',[0.68 0.73 0.06 0.13],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text182',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);

h47 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','# Frames',...
'Style','text',...
'Position',[0.68 0.6 0.06 0.098],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text183',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);

h53 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Codec',...
'Style','text',...
'Position',[0.66 0.14 0.055 0.098],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text192',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);

h48 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'GStreamer'; 'Cortex' },...
'Style','popupmenu',...
'Value',1,...
'Position',[0.58 0.12 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKSettingsmovieType_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKSettingsmovieType',...
'FontSize',ssize,...
'FontName',nfont);

h48a = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Recorder',...
'Style','text',...
'Position',[0.58 0.05 0.08 0.13],...
'BackgroundColor',bcolour,...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h52 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','default',...
'Style','edit',...
'Position',[0.58 0.44 0.07 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKSettingsmovieCodec_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKSettingsmovieCodec',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);

h54 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','OPX Server',...
'Style','checkbox',...
'Position',[0.8 0.9 0.08 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKOmniplexEnable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKOmniplexEnable',...
'FontSize',ssize,...
'FontName',nfont );

h49 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','10.0.0.1',...
'Style','edit',...
'Position',[0.8 0.8 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKOmniplexIP',...
'Enable','off',...
'FontSize',msize,...
'FontName',mfont );

h50 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','9889',...
'Style','edit',...
'Position',[0.93 0.8 0.04 0.13],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKOmniplexPort',...
'Enable','off',...
'FontSize',msize,...
'FontName',mfont);

h51 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Port',...
'Style','text',...
'Position',[0.97 0.8 0.02 0.13],...
'BackgroundColor',bcolour,...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h55 = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','IP',...
'Style','text',...
'Position',[0.9 0.8 0.01 0.13],...
'BackgroundColor',bcolour,...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h56b = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Eye Occluder Port',...
'Style','text',...
'Position',[0.9 0.57 0.1 0.13],...
'BackgroundColor',bcolour,...
'HorizontalAlignment','left',...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h56 = uicontrol(...7
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','',...
'Style','edit',...
'Position',[0.8 0.6 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKeyeOccluder',...
'FontSize',msize,...
'FontName',mfont);

h56c = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','simple',...
'Style','edit',...
'Position',[0.8 0.4 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKdPPMode',...
'FontSize',msize,...
'FontName',mfont);

h56d = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Strobe Type',...
'Style','text',...
'Position',[0.9 0.36 0.1 0.14],...
'BackgroundColor',bcolour,...
'HorizontalAlignment','left',...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h56e = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','/dev/ttyACM0',...
'Style','edit',...
'Position',[0.8 0.2 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKarduinoPort',...
'FontSize',msize,...
'FontName',mfont);

h56f = uicontrol(...
'Parent',h28,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Arduino Port',...
'Style','text',...
'Position',[0.9 0.16 0.1 0.14],...
'BackgroundColor',bcolour,...
'HorizontalAlignment','left',...
'Children',[],...
'FontSize',ssize,...
'FontName',nfont);

h61 = uibuttongroup(...
'Parent',tab2,...
'FontUnits','points',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'Title','',...
'BorderType','none',...
'Position',[0 0 1 1],...
'Visible','on',...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelTraining',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');


h64 = uicontrol(...
'Parent',h61,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','normalized',...
'String','Load State File',...
'Position',[0.882 0.412 0.108 0.135],...
'Callback',@(hObject,eventdata)opticka_ui('OKLoadStateButton_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKLoadStateButton',...
'FontSize',msize,...
'FontName',nfont);


h65 = uicontrol(...
'Parent',h61,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','normalized',...
'String','Edit State File',...
'Position',[0.882 0.251 0.108 0.135],...
'Callback',@(hObject,eventdata)opticka_ui('OKEditStateFileButon_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKEditStateFileButon',...
'FontSize',msize,...
'FontName',nfont);


h62 = uicontrol(...
'Parent',h61,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Simulcra',...
'Style','edit',...
'Position',[0.88 0.9 0.1 0.1],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKTrainingName_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKTrainingName',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);


h63 = uicontrol(...
'Parent',h61,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Subject',...
'Style','text',...
'Position',[0.88 0.8 0.05 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Enable','on',...
'Tag','text209',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);


h66 = uicontrol(...
'Parent',h61,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Joanna Doe',...
'Style','edit',...
'Position',[0.88 0.7 0.1 0.1],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKTrainingResearcherName_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKTrainingResearcherName',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);


h67 = uicontrol(...
'Parent',h61,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Researcher',...
'Style','text',...
'Position',[0.88 0.6 0.1 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Enable','on',...
'Tag','text4554',...
'UserData',[],...
'FontSize',ssize,...
'FontName',nfont);


h69 = uicontrol(...
'Parent',h61,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','normalized',...
'String','Refresh View...',...
'Position',[0.882516188714154 0.0903225806451613 0.108233117483811 0.135483870967742],...
'Callback',@(hObject,eventdata)opticka_ui('OKRefreshStateInfo_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKRefreshStateInfo',...
'FontSize',msize,...
'FontName',nfont);


h70 = uicontrol(...
'Parent',h61,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','File Name:',...
'Style','text',...
'Position',[0 0 0.8 0.07],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.38 0.38 0.38],...
'Tag','OKTrainingFileName',...
'UserData',[],...
'FontSize',ssize,...
'FontName',mfont);


h68 = uicontrol(...
'Parent',h61,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','normalized',...
'HorizontalAlignment','left',...
'Max',500,...
'String','State Info here...',...
'Style','edit',...
'Value',10,...
'Position',[0 0.1 0.88 0.9],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKTrainingText',...
'FontSize',msize,...
'FontName',mfont);


h71 = uitoolbar(...
'Parent',h1,...
'Tag','OKToolbar');

appdata.toolid = [];
h72 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{1},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarInitialise_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'TooltipString','Initialise Opticka with fresh settings',...
'Tag','OKToolbarInitialise');

appdata.toolid = 'Standard.FileOpen';
appdata.CallbackInUse = struct(...
    'ClickedCallback', 'opticka_ui(''OKToolbarOpen_ClickedCallback'',gcbo,[],guidata(gcbo))');
h73 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{2},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarOpen_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'TooltipString','Open File',...
'BusyAction','cancel',...
'Interruptible','off',...
'Tag','OKToolbarOpen');

appdata.toolid = [];
h74 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{3},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKSaveData_Callback',hObject,eventdata,guidata(hObject)),...
'TooltipString','Save as Data',...
'Tag','OKToolbarSave');

appdata.toolid = [];
h75 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{4},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarDefinePath_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Separator','on',...
'TooltipString','Choose a default folder to save eyelink and other log files',...
'Tag','OKToolbarDefinePath');

appdata.toolid = [];
h76 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{5},...
'Enable','off',...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToggleUI_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Separator','on',...
'TooltipString','Toggle settings panels...',...
'Tag','OKToggleUI');

appdata.toolid = [];
h77 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{6},...
'Separator','on',...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKRFMapper_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Separator','on',...
'TooltipString','Start the RF Mapper',...
'Tag','OKRFMapper');

appdata.toolid = [];
h78 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{7},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKStartTask_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Separator',get(0,'defaultuipushtoolSeparator'),...
'TooltipString','Start behavioural task...',...
'Tag','OKStartTask');

appdata.toolid = [];

h79 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{8},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarRun_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Separator',get(0,'defaultuipushtoolSeparator'),...
'TooltipString','Start MOC Task',...
'Tag','OKToolbarRun');

appdata.toolid = [];

h80 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{9},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarStop_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'TooltipString','STOP',...
'Tag','OKToolbarStop');

appdata.toolid = [];

h81 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{10},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKToolbarAbort_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'TooltipString','ABORT',...
'Tag','OKToolbarAbort');

appdata.toolid = [];

h82 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{11},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKPanelTellOmniplex_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'Separator','on',...
'TooltipString','Connect to Omniplex!',...
'Tag','OKToolbarTellOmniplex');

appdata.toolid = [];

h83 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{12},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKPanelReconnectOmniplex_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'TooltipString','Reconnect to Omniplex!',...
'Tag','OKPanelReconnectOmniplex');

appdata.toolid = [];

h84 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{13},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKPanelSendOmniplex_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'TooltipString','Send Omniplex Stimulus',...
'Tag','OKPanelSendOmniplex');

appdata.toolid = [];

h85 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{14},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKPanelPingOmniplex_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'Enable','off',...
'TooltipString','Ping Omniplex',...
'Tag','OKPanelPingOmniplex');

appdata.toolid = [];

h86 = uipushtool(...
'Parent',h71,...
'Children',[],...
'CData',mat{15},...
'ClickedCallback',@(hObject,eventdata)opticka_ui('OKPanelDisconnectOmniplex_ClickedCallback',hObject,eventdata,guidata(hObject)),...
'TooltipString','Disconnect Omniplex',...
'Enable','off',...
'Tag','OKPanelDisconnectOmniplex');

appdata.toolid = [];

h87 = uitoggletool(...
'Parent',h71,...
'Children',[],...
'CData',mat{16},...
'Enable','off',...
'Separator','on',...
'TooltipString','Toggle into remote client mode',...
'OnCallback',@(hObject,eventdata)opticka_ui('OKToolbarToggleRemote_OnCallback',hObject,eventdata,guidata(hObject)),...
'Tag','OKToolbarToggleRemote');

h88 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuPreferences_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Calibration',...
'Tag','OKMenuPreferences');

h89 = uimenu(...
'Parent',h88,...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuCalibrateLuminance_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Calibrate Gamma...',...
'Tag','OKMenuCalibrateLuminance');

h90 = uimenu(...
'Parent',h88,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuCalibrateSize_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Calibrate Size...',...
'Tag','OKMenuCalibrateSize');

h91 = uimenu(...
'Parent',h88,...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuLoadGamma_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Load Gamma...',...
'Tag','OKMenuLoadGamma');

h92 = uimenu(...
'Parent',h88,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuSaveGamma_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Save Gamma...',...
'Tag','OKMenuSaveGamma');

h92a = uimenu(...
'Parent',h88,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuClearGamma_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Clear Gamma',...
'Tag','OKMenuClearGamma');

h93 = uimenu(...
'Parent',h88,...
'Enable','off',...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenumanageCode_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Check for Updates',...
'Tag','OKMenumanageCode');

h94 = uimenu(...
'Parent',h88,...
'Enable','off',...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuEditConfiguration_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Edit Configuration',...
'Tag','OKMenuEditConfiguration');

h95 = uibuttongroup(...
'Parent',tab1,...
'FontUnits','pixels',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'TitlePosition','righttop',...
'Title','',...
'BorderType','none',...
'Position',[0 0 1 1],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelGlobal',...
'FontSize',lsize,...
'FontName',nfont,...
'FontWeight','bold');

h122 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Gamma',...
'Style','text',...
'Position',[0.287 0.4 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text189',...
'FontSize',msize,...
'FontName',nfont);

h108 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Window',...
'Style','text',...
'Position',[0.1 0.38 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text83',...
'FontSize',msize,...
'FontName',nfont);

h110 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Src Blend',...
'Style','text',...
'Position',[0.287 0.88 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text100',...
'FontSize',msize,...
'FontName',nfont);

h111 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Dst blend',...
'Style','text',...
'Position',[0.287 0.72 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text101',...
'FontSize',msize,...
'FontName',nfont);

h105 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','X Center',...
'Style','text',...
'Position',[0.1 0.23 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text6',...
'FontSize',msize,...
'FontName',nfont);

h106 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Y Center',...
'Style','text',...
'Position',[0.1 0.07 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text7',...
'FontSize',msize,...
'FontName',nfont);

h99 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Monitor',...
'Style','text',...
'Position',[0.1 0.872 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text3',...
'FontSize',msize,...
'FontName',nfont);

h124 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Bit Depth',...
'Style','text',...
'Position',[0.287 0.57 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'TooltipString','Bit Depth of backing framebuffer',...
'Tag','text191',...
'FontSize',msize,...
'FontName',nfont);

h100 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Distance(cm)',...
'Style','text',...
'Position',[0.1 0.7 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text4',...
'FontSize',msize,...
'FontName',nfont);

h130 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Background',...
'Style','text',...
'Position',[0.54 0.88 0.09 0.09],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text8',...
'FontSize',msize,...
'FontName',nfont);

h101 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Px / cm',...
'Style','text',...
'Position',[0.1 0.55 0.06 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text5',...
'FontSize',msize,...
'FontName',nfont);

h96 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Anti-Aliasing',...
'Style','text',...
'Position',[0.287 0.235 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text102',...
'FontSize',msize,...
'FontName',nfont);

h97 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','57.3',...
'Style','edit',...
'Position',[0 0.7 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKMonitorDistance_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKMonitorDistance',...
'FontSize',msize,...
'FontName',mfont);

h98 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','32',...
'Style','edit',...
'Position',[0 0.547 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKpixelsPerCm_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Pixels per cm as calculated during screen calibration',...
'Tag','OKpixelsPerCm',...
'FontSize',msize,...
'FontName',mfont);

h102 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','[]',...
'Style','edit',...
'Position',[0 0.38 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKWindowSize_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Enter an [] matrix for automatic fullscreen or a [W H] matrix for a widthxheight window',...
'Tag','OKWindowSize',...
'FontSize',msize,...
'FontName',mfont);

h103 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','0',...
'Style','edit',...
'Position',[0 0.22 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKscreenXOffset_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKscreenXOffset',...
'FontSize',msize,...
'FontName',mfont);

h104 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','0',...
'Style','edit',...
'Position',[0 0.0621 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKscreenYOffset_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKscreenYOffset',...
'FontSize',msize,...
'FontName',mfont);

h107 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','GL Blending',...
'Value',1,...
'Style','checkbox',...
'Position',[0.369 0.73 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKOpenGLBlending_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Enable global OpenGL blending for PTB?',...
'Tag','OKOpenGLBlending',...
'FontSize',msize,...
'FontName',nfont);

h109 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{ '0'; '1' },...
'Style','popupmenu',...
'Value',1,...
'Position',[0 0.86 0.1 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKSelectScreen_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKSelectScreen',...
'FontSize',msize,...
'FontName',mfont);

h112 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Hide Flash',...
'Style','checkbox',...
'Position',[0.369 0.34375 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKHideFlash_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Use Mario''s gamma trick to hide black flash onset',...
'Tag','OKHideFlash',...
'FontSize',msize,...
'FontName',nfont);

h112b = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Use Retina',...
'Style','checkbox',...
'Position',[0.369 0.22 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKHideFlash_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Use native retina resolution rather than OS downscaled resolution',...
'Tag','OKUseRetina',...
'FontSize',msize,...
'FontName',nfont);

h112c = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Draw Fixation',...
'Style','checkbox',...
'Position',[0.369 0.1 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKHideFlash_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Draw simple fixation cross for MOC tasks only',...
'Tag','OKDrawFixation',...
'FontSize',msize,...
'FontName',nfont);

h112c = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Dummy Eyetracker',...
'Style','checkbox',...
'Position',[0.48 0.1 0.11 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKHideFlash_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Use dummy-mode for eyetracker connection?',...
'Tag','OKDummyMode',...
'FontSize',msize,...
'FontName',nfont);

h113 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Photodiode',...
'Style','checkbox',...
'Position',[0.48 0.478 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKUsePhotoDiode_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Show a white<->black square to log stimulus onset with a photodiode.',...
'Tag','OKUsePhotoDiode',...
'FontSize',msize,...
'FontName',nfont);

h114 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Verbose',...
'Style','checkbox',...
'Position',[0.369 0.59375 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKVerbose_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Show more information in the command window?',...
'Tag','OKVerbose',...
'FontSize',msize,...
'FontName',nfont);

h115 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Debug Mode',...
'Style','checkbox',...
'Position',[0.369 0.46875 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKDebug_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Show onscreen info and disregard timing errors',...
'Tag','OKDebug',...
'FontSize',msize,...
'FontName',nfont);

h116 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'GL_ZERO'; 'GL_ONE'; 'GL_DST_COLOR'; 'GL_ONE_MINUS_DST_COLOR'; 'GL_SRC_ALPHA'; 'GL_ONE_MINUS_SRC_ALPHA'; 'GL_DST_ALPHA'; 'GL_ONE_MINUS_DST_ALPHA'; 'GL_SRC_ALPHA_SATURATE' },...
'Style','popupmenu',...
'Value',5,...
'Position',[0.176 0.86 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKGLSrc_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKGLSrc',...
'FontSize',msize,...
'FontName',mfont);

h117 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'GL_ZERO'; 'GL_ONE'; 'GL_DST_COLOR'; 'GL_ONE_MINUS_DST_COLOR'; 'GL_SRC_ALPHA'; 'GL_ONE_MINUS_SRC_ALPHA'; 'GL_DST_ALPHA'; 'GL_ONE_MINUS_DST_ALPHA'; 'GL_SRC_ALPHA_SATURATE' },...
'Style','popupmenu',...
'Value',6,...
'Position',[0.176 0.7 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKGLDst_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKGLDst',...
'FontSize',msize,...
'FontName',mfont);

h118 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','0',...
'Style','edit',...
'Position',[0.176 0.22 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKAntiAliasing_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Global anti-aliasing',...
'Tag','OKAntiAliasing',...
'FontSize',msize,...
'FontName',mfont);

h119 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Native BeamPos',...
'Style','checkbox',...
'Position',[0.48 0.217 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKNativeBeamPosition_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Use the OS native beam position (ON) queries or override (OFF) with PTB routine; override is better for OS X along with use of the kernel driver',...
'Tag','OKNativeBeamPosition',...
'FontSize',msize,...
'FontName',nfont);

h120 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Record Movie',...
'Style','checkbox',...
'Position',[0.48 0.35 0.1 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKrecordMovie_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Enable PTB stimulus recording, currently buggy as gstreamer not stable',...
'Tag','OKrecordMovie',...
'FontSize',msize,...
'FontName',nfont);

h121 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','None',...
'Style','popupmenu',...
'Value',1,...
'Position',[0.176 0.38 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKUseGamma_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKUseGamma',...
'FontSize',msize,...
'FontName',nfont);

h123 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Log Times',...
'Style','checkbox',...
'Value',1,...
'Position',[0.48 0.73 0.080 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKlogFrames_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Log each frame time to check for dropped frames etc.',...
'Tag','OKlogFrames',...
'FontSize',msize,...
'FontName',nfont);

h125 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String', {'FloatingPoint32BitIfPossible'; 'FloatingPoint32Bit';...
	'Native10Bit'; '8bit'; 'PseudoGray'; ...
	'EnableBits++Bits++Output'; 'EnableBits++Mono++Output'; ...
	'EnableBits++Color++Output'; 'EnableBits++Mono++OutputWithOverlay'; ...
	'Native11Bit'; 'Native16Bit'; ...
	'Native16BitFloat'; 'FixedPoint16Bit'; 'FloatingPoint16Bit' },...
'Style','popupmenu',...
'Value',1,...
'Position',[0.176 0.547 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKbitDepth_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKbitDepth',...
'FontSize',msize,...
'FontName',nfont);

h126 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','4',...
'Style','edit',...
'Position',[0.176 0.0621 0.11 0.13],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKverbosityLevel_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Level of verbosity logging used by PTB',...
'Tag','OKverbosityLevel',...
'FontSize',msize,...
'FontName',mfont);

h127 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Benchmark',...
'Style','checkbox',...
'Position',[0.48 0.609 0.080 0.1],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKbenchmark_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Flip as fast as possible to test maximum framerate',...
'Tag','OKbenchmark',...
'FontSize',msize,...
'FontName',nfont);

h128 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Verbosity',...
'TooltipString','Control the verbosity of PTB logging to command window',...
'Style','text',...
'Position',[0.287 0.085 0.08 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text203',...
'FontSize',msize,...
'FontName',nfont);

h129 = uicontrol(...
'Parent',h95,...
'FontUnits','pixels',...
'Units','normalized',...
'String','0.5 0.5 0.5 0',...
'Style','edit',...
'Position',[0.370027752081406 0.87 0.17 0.13],...
'BackgroundColor',[1 1 1],...
'TooltipString','RGBA colour for background of screen',...
'Callback',@(hObject,eventdata)opticka_ui('OKbackgroundColour_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKbackgroundColour',...
'FontSize',msize,...
'FontName',mfont);

h131 = uibuttongroup(...
'Parent',h95,...
'FontUnits','points',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'Title','Trial Randomisation Options',...
'TitlePosition','righttop',...
'Position',[0.6 0.015 0.40 0.98],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','uipanel45',...
'FontSize',ssize,...
'FontName',nfont,...
'FontWeight','bold');

h132 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Randomise Order',...
'Style','checkbox',...
'Value',1,...
'Position',[0.023 0.27 0.265 0.14],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKRandomise_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKRandomise',...
'FontSize',msize,...
'FontName',nfont);

h133 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'mt19937ar'; 'mcg16807'; 'mrg32k3a'; 'swb2712' },...
'Style','popupmenu',...
'Value',1,...
'Position',[0.023 0.45 0.25 0.14],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKrandomGenerator_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKrandomGenerator',...
'FontSize',msize,...
'FontName',nfont);

h134 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Random Type',...
'Style','text',...
'Position',[0.28 0.49 0.2 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text105',...
'FontSize',msize,...
'FontName',nfont);

h135 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','[]',...
'Style','edit',...
'Position',[0.023 0.63 0.25 0.14],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKRandomSeed_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Random seed for the random number generator',...
'Tag','OKRandomSeed',...
'FontSize',msize,...
'FontName',mfont);

h136 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Random Seed',...
'Style','text',...
'Position',[0.28 0.687 0.17 0.1],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text106',...
'FontSize',msize,...
'FontName',nfont);

h137 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','5',...
'Style','edit',...
'Position',[0.023 0.83 0.25 0.14],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKnBlocks_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKnBlocks',...
'FontSize',msize,...
'FontName',mfont);

h138 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','0.5',...
'Style','edit',...
'Position',[0.49 0.64 0.25 0.137],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKisTime_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Inter-trial time for acute run (not using state machine)',...
'Tag','OKisTime',...
'FontSize',msize,...
'FontName',mfont);

h139 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Trial Blocks',...
'Style','text',...
'Position',[0.28 0.88 0.16 0.09],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text9',...
'FontSize',msize,...
'FontName',nfont);

h140 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Intertrial Time',...
'Style','text',...
'Position',[0.75 0.68 0.22 0.09],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text10',...
'FontSize',msize,...
'FontName',nfont);

h141 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','1',...
'Style','edit',...
'Position',[0.49 0.47 0.25 0.137],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKibTime_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Inter-block time (not using state machine)',...
'Tag','OKibTime',...
'FontSize',msize,...
'FontName',mfont);

h142 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','InterBlock Time',...
'Style','text',...
'Position',[0.75 0.5 0.22 0.09],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text104',...
'FontSize',msize,...
'FontName',nfont);

h143 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','2',...
'Style','edit',...
'Position',[0.49 0.842465753424657 0.25 0.137],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKtrialTime_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','Trial time for MOC task (not using state machine)',...
'Tag','OKtrialTime',...
'FontSize',msize,...
'FontName',mfont);

h144 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','MOC Trial Time',...
'TooltipString','This is used for MOC tasks, for behavioural tasks it will be overwritten...',...
'Style','text',...
'Position',[0.75 0.88 0.247 0.09],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text107',...
'FontSize',msize,...
'FontName',nfont);

h145 = uicontrol(...
'Parent',h131,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Use Clock Time?',...
'Style','checkbox',...
'Value',1,...
'Position',[0.023 0.11 0.24 0.14],...
'BackgroundColor',bcolour,...
'Callback',@(hObject,eventdata)opticka_ui('OKrealTime_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'TooltipString','If ON then we use absoloute time which is less liable to error build-up, otherwise measure time in number of frames needed to show, and even if frames are dropped, opticka simply shows the right number of frames ignoring possible time drift (better for record movie mode)',...
'Tag','OKrealTime',...
'FontSize',msize,...
'FontName',nfont);

h184 = uipanel(...
'Parent',h146,...
'FontUnits',get(0,'defaultuipanelFontUnits'),...
'Units',get(0,'defaultuipanelUnits'),...
'ForegroundColor',[0.49 0.49 0.49],...
'HighlightColor',bcolour,...
'BorderType','none',...
'TitlePosition','centertop',...
'Title',blanks(0),...
'Position',[0.3 0.45 0.7 0.55],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelStimulus',...
'FontSize',lsize,...
'FontName',nfont);

h185 = uicontrol(...
'Parent',h184,...
'FontUnits',get(0,'defaultuicontrolFontUnits'),...
'Units','normalized',...
'String','Stimulus options...',...
'Style','text',...
'Position',[0.38 0.4 0.22 0.088],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.49 0.49 0.49],...
'Enable','off',...
'Tag','OKPanelStimulusText',...
'FontSize',lsize,...
'FontName',nfont);

h147 = uibuttongroup(...
'Parent',h146,...
'FontUnits','pixels',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'ShadowColor',[0.50 0.50 0.50],...
'Title','Stimulus List',...
'Position',[0 0.45 0.3 0.55],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelStimulusList',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont,...
'FontWeight','bold');

h148 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Add',...
'Position',[0.0157 0.0266 0.172 0.113],...
'Callback',@(hObject,eventdata)opticka_ui('OKAddStimulus_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKAddStimulus',...
'FontSize',msize,...
'FontName',nfont);

h149 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Delete',...
'Position',[0.213 0.0266 0.172 0.113],...
'Callback',@(hObject,eventdata)opticka_ui('OKDeleteStimulus_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKDeleteStimulus',...
'FontSize',msize,...
'FontName',nfont);

h150 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Copy',...
'Position',[0.411 0.0266 0.172 0.113],...
'Callback',@(hObject,eventdata)opticka_ui('OKCopyStimulus_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKCopyStimulus',...
'FontSize',msize,...
'FontName',nfont);

h151 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','?',...
'Position',[0.941 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKInspectStimulus_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKInspectStimulus',...
'FontSize',ssize,...
'FontName',nfont);

h152 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Modify / Examine',...
'Position',[0.61 0.026 0.37 0.113],...
'Callback',@(hObject,eventdata)opticka_ui('OKModifyStimulus_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKModifyStimulus',...
'FontSize',msize,...
'FontName',nfont);

h153 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','<html>&darr;</html>',...
'Position',[0.883 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusDown_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKStimulusDown',...
'FontSize',ssize,...
'FontName',nfont);

h154 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','<html>&uarr;</html>',...
'Position',[0.825 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusUp_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKStimulusUp',...
'FontSize',ssize,...
'FontName',nfont);

h155 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','R',...
'Position',[0.766 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusRun_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'TooltipString','Run the selected stimulus in a window',...
'Tag','OKStimulusRun',...
'FontSize',ssize,...
'FontName',nfont);

h156 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','BR',...
'Position',[0.708 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusRunBenchmark_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'TooltipString','Run the selected stimulus and benchmark maximum FPS',...
'Tag','OKStimulusRunBenchmark',...
'FontSize',ssize,...
'FontName',nfont);

h157 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','A',...
'Position',[0.650 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusRunAll_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'TooltipString','Preview All Stimuli...',...
'Tag','OKStimulusRunAll',...
'FontSize',ssize,...
'FontName',nfont);

h158 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','BA',...
'Position',[0.592 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusRunAllBenchmark_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'TooltipString','Benchmark All Stimuli...',...
'Tag','OKStimulusRunAllBenchmark',...
'FontSize',ssize,...
'FontName',nfont);

h159 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'Style','listbox',...
'Value',1,...
'Position',[0.0157 0.167 0.974 0.756],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimList_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKStimList',...
'FontSize',msize,...
'FontName',nfont);

h160 = uicontrol(...
'Parent',h147,...
'FontUnits','pixels',...
'Units','normalized',...
'String','RS',...
'Position',[0.533 0.93 0.05 0.06],...
'Callback',@(hObject,eventdata)opticka_ui('OKStimulusRunSingle_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'TooltipString','Single run using eyetracker',...
'Tag','OKStimulusRunSingle',...
'FontSize',ssize,...
'FontName',nfont);

h161 = uicontrol(...
'Parent',h146,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','right',...
'String','OPX Server for Online PSTH: disconnected',...
'Style','text',...
'Position',[0.287 0 0.7 0.037],...
'BackgroundColor',bcolour,...
'Children',[],...
'Enable','off',...
'ForegroundColor',[0.2 0.2 0.2],...
'TooltipString','This connection status is for the online display ONLY, it does not affect data collection communication via the datapixx',...
'Tag','OKOmniplexStatus',...
'FontSize',13,...
'FontName',nfont,...
'FontWeight','bold');

h162 = uicontrol(...
'Parent',h146,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Loading...',...
'Style','text',...
'Position',[0 0 0.3 0.037],...
'BackgroundColor',bcolour,...
'Children',[],...
'ForegroundColor',[0.8 0.2 0],...
'Tag','OKOptickaVersion',...
'FontSize',13,...
'FontName',nfont,...
'FontWeight','bold');

h163 = uipanel(...
'Parent',h146,...
'FontUnits','pixels',...
'Units',get(0,'defaultuipanelUnits'),...
'ForegroundColor',[0.38 0.38 0.38],...
'ShadowColor',[0.5 0.5 0.5],...
'TitlePosition','centertop',...
'Title','Independent Variables',...
'Position',[0.3 0.043 0.7 0.4],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','OKPanelVariables',...
'FontSize',msize,...
'FontName',nfont,...
'FontWeight','bold');

h164 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Affects Stimuli',...
'Style','text',...
'Position',[0.4 0.43 0.1 0.08],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text140',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);

h165 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Variable Values',...
'Style','text',...
'Position',[0.4 0.57 0.1 0.08],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text141',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);

h166 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Variable Name',...
'Style','text',...
'Position',[0.4 0.74 0.1 0.08],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text142',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);

h167 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','<<',...
'Position',[0.52 0.53 0.05 0.1],...
'Callback',@(hObject,eventdata)opticka_ui('OKCopyVariableName_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKCopyVariableName',...
'FontSize',msize,...
'FontName',nfont);

h170 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','<-',...
'Position',[0.52 0.42 0.05 0.1],...
'Callback',@(hObject,eventdata)opticka_ui('OKCopyVariableNameValues_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKCopyVariableNameValues',...
'FontSize',msize,...
'FontName',nfont);


h168 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','lin',...
'Position',[0.05 0.5 0.05 0.1],...
'Callback',@(hObject,eventdata)opticka_ui('OKVariablesLinear_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKVariablesLinear',...
'FontSize',msize,...
'FontName',nfont);

h169 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','log',...
'Position',[0 0.5 0.05 0.1],...
'Callback',@(hObject,eventdata)opticka_ui('OKVariablesLog_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKVariablesLog',...
'FontSize',msize,...
'FontName',nfont);

h171 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'HorizontalAlignment','left',...
'String','Stimulus; Offset',...
'Style','text',...
'Position',[0.4 0.28 0.11 0.08],...
'BackgroundColor',bcolour,...
'Children',[],...
'Tag','text178',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont);

h172 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','1',...
'Style','edit',...
'Position',[0.11 0.39 0.287 0.16],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKVariableStimuli',...
'UserData',[],...
'FontSize',13,...
'FontName',mfont);

h173 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','{[-5 -5],[0 0],[5 5]}',...
'Style','edit',...
'Position',[0.11 0.55 0.287 0.16],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKVariableValues',...
'UserData',[],...
'FontSize',13,...
'FontName',mfont);

h174 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','xyPosition',...
'Style','edit',...
'Position',[0.11 0.72 0.287 0.16],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKVariableName',...
'UserData',[],...
'FontSize',13,...
'FontName',mfont);

h175 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String','[]',...
'Style','edit',...
'Position',[0.11 0.22 0.287 0.16],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKVariableOffset_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKVariableOffset',...
'UserData',[],...
'FontSize',13,...
'FontName',mfont);

h176 = uicontrol(...
'Parent',h163,...
'FontUnits','pixels',...
'Units','normalized',...
'String',{  'xyPosition';'xPosition'; 'yPosition'; 'angle'; 'colour'; 'direction'; 'size'; 'sf'; 'tf'; 'contrast'; 'alpha'; 'speed'; 'phase'; 'startPosition'; 'barHeight'; 'barWidth'; 'alpha'; 'nDots'; 'coherence'; 'scale'; 'driftDirection' },...
'Style','listbox',...
'Value',1,...
'Position',[0.58 0.025 0.4 0.925],...
'BackgroundColor',[1 1 1],...
'Callback',@(hObject,eventdata)opticka_ui('OKVariableList_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKVariableList',...
'FontSize',13,...
'FontName',mfont);

h177 = uibuttongroup(...
'Parent',h146,...
'FontUnits','pixels',...
'Units','normalized',...
'ForegroundColor',[0.3 0.3 0.3],...
'ShadowColor',[0.5 0.5 0.5],...
'Title','Independent Variable List',...
'Position',[0 0.043 0.3 0.4],...
'BackgroundColor',bcolour,...
'Clipping','off',...
'Tag','uipanel44',...
'UserData',[],...
'FontSize',msize,...
'FontName',nfont,...
'FontWeight','bold');

h178 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Add',...
'Position',[0.0159 0.0266 0.233 0.114],...
'Callback',@(hObject,eventdata)opticka_ui('OKAddVariable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Tag','OKAddVariable',...
'FontSize',msize,...
'FontName',nfont);

h179 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Delete',...
'Position',[0.261 0.0266 0.233 0.114],...
'Callback',@(hObject,eventdata)opticka_ui('OKDeleteVariable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKDeleteVariable',...
'FontSize',msize,...
'FontName',nfont);

h180 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Copy',...
'Position',[0.506 0.0266 0.233 0.114],...
'Callback',@(hObject,eventdata)opticka_ui('OKCopyVariable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKCopyVariable',...
'FontSize',msize,...
'FontName',nfont);

h181 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'String','Edit',...
'Position',[0.755 0.0266 0.233 0.114],...
'Callback',@(hObject,eventdata)opticka_ui('OKEditVariable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','off',...
'Tag','OKEditVariable',...
'FontSize',msize,...
'FontName',nfont);

h182 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'String','?',...
'Position',[0.94 0.92 0.05 0.08],...
'Callback',@(hObject,eventdata)opticka_ui('OKInspectVariable_Callback',hObject,eventdata,guidata(hObject)),...
'Children',[],...
'Enable','on',...
'Tag','OKInspectVariable',...
'FontSize',ssize,...
'FontName',nfont);

h183 = uicontrol(...
'Parent',h177,...
'FontUnits','pixels',...
'Units','normalized',...
'Style','listbox',...
'Value',1,...
'Position',[0.0159 0.168 0.975 0.757],...
'BackgroundColor',[1 1 1],...
'Children',[],...
'Tag','OKVarList',...
'FontSize',msize,...
'FontName',nfont);

h186 = uimenu(...
'Parent',h1,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuLogs_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Logs',...
'Tag','OKMenuLogs');

h187 = uimenu(...
'Parent',h186,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuAllTimingLogs_Callback',hObject,eventdata,guidata(hObject)),...
'Label','All Timing Logs',...
'Tag','OKMenuAllTimingLogs');

h187b = uimenu(...
'Parent',h186,...
'Callback',@(hObject,eventdata)opticka_ui('OKMenusMLogs_Callback',hObject,eventdata,guidata(hObject)),...
'Label','State Machine Logs',...
'Tag','OKMenusMLogs');

h188 = uimenu(...
'Parent',h186,...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuStimulusLog_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Stimulus Sequence',...
'Tag','OKMenuStimulusLog');

h189 = uimenu(...
'Parent',h186,...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenuShowGammaPlots_Callback',hObject,eventdata,guidata(hObject)),...
'Label','Gamma Correction Plots',...
'Tag','OKMenuShowGammaPlots');

h190 = uimenu(...
'Parent',h186,...
'Enable','off',...
'Separator','on',...
'Callback',@(hObject,eventdata)opticka_ui('OKMenurfMapperLog_Callback',hObject,eventdata,guidata(hObject)),...
'Label','RF Mapper Log',...
'Tag','OKMenurfMapperLog');

hsingleton = h1;

% --- Handles default GUIDE GUI creation and callback dispatch
function varargout = gui_mainfcn(gui_State, varargin)

gui_StateFields =  {'gui_Name'
    'gui_Singleton'
    'gui_OpeningFcn'
    'gui_OutputFcn'
    'gui_LayoutFcn'
    'gui_Callback'};
gui_Mfile = '';
for i=1:length(gui_StateFields)
    if ~isfield(gui_State, gui_StateFields{i})
        error(message('MATLAB:guide:StateFieldNotFound', gui_StateFields{ i }, gui_Mfile));
    elseif isequal(gui_StateFields{i}, 'gui_Name')
        gui_Mfile = [gui_State.(gui_StateFields{i}), '.m'];
    end
end

numargin = length(varargin);

if numargin == 0
    % OPTICKA_UI_EXPORT
    % create the GUI only if we are not in the process of loading it
    % already
    gui_Create = true;
elseif local_isInvokeActiveXCallback(gui_State, varargin{:})
    % OPTICKA_UI_EXPORT(ACTIVEX,...)
    vin{1} = gui_State.gui_Name;
    vin{2} = [get(varargin{1}.Peer, 'Tag'), '_', varargin{end}];
    vin{3} = varargin{1};
    vin{4} = varargin{end-1};
    vin{5} = guidata(varargin{1}.Peer);
    feval(vin{:});
    return;
elseif local_isInvokeHGCallback(gui_State, varargin{:})
    % OPTICKA_UI_EXPORT('CALLBACK',hObject,eventData,handles,...)
    gui_Create = false;
else
    % OPTICKA_UI_EXPORT(...)
    % create the GUI and hand varargin to the openingfcn
    gui_Create = true;
end

if ~gui_Create
    % In design time, we need to mark all components possibly created in
    % the coming callback evaluation as non-serializable. This way, they
    % will not be brought into GUIDE and not be saved in the figure file
    % when running/saving the GUI from GUIDE.
    designEval = false;
    if (numargin>1 && ishghandle(varargin{2}))
        fig = varargin{2};
        while ~isempty(fig) && ~ishghandle(fig,'figure')
            fig = get(fig,'parent');
        end
        
        designEval = isappdata(0,'CreatingGUIDEFigure') || (isscalar(fig)&&isprop(fig,'GUIDEFigure'));
    end
        
    if designEval
        beforeChildren = findall(fig);
    end
    
    % evaluate the callback now
    varargin{1} = gui_State.gui_Callback;
    if nargout
        [varargout{1:nargout}] = feval(varargin{:});
    else       
        feval(varargin{:});
    end
    
    % Set serializable of objects created in the above callback to off in
    % design time. Need to check whether figure handle is still valid in
    % case the figure is deleted during the callback dispatching.
    if designEval && ishghandle(fig)
        set(setdiff(findall(fig),beforeChildren), 'Serializable','off');
    end
else
    if gui_State.gui_Singleton
        gui_SingletonOpt = 'reuse';
    else
        gui_SingletonOpt = 'new';
    end

    % Check user passing 'visible' P/V pair first so that its value can be
    % used by oepnfig to prevent flickering
    gui_Visible = 'auto';
    gui_VisibleInput = '';
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        % Recognize 'visible' P/V pair
        len1 = min(length('visible'),length(varargin{index}));
        len2 = min(length('off'),length(varargin{index+1}));
        if ischar(varargin{index+1}) && strncmpi(varargin{index},'visible',len1) && len2 > 1
            if strncmpi(varargin{index+1},'off',len2)
                gui_Visible = 'invisible';
                gui_VisibleInput = 'off';
            elseif strncmpi(varargin{index+1},'on',len2)
                gui_Visible = 'visible';
                gui_VisibleInput = 'on';
            end
        end
    end
    
    % Open fig file with stored settings.  Note: This executes all component
    % specific CreateFunctions with an empty HANDLES structure.

    
    % Do feval on layout code in m-file if it exists
    gui_Exported = ~isempty(gui_State.gui_LayoutFcn);
    % this application data is used to indicate the running mode of a GUIDE
    % GUI to distinguish it from the design mode of the GUI in GUIDE. it is
    % only used by actxproxy at this time.   
    setappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]),1);
    if gui_Exported
        gui_hFigure = feval(gui_State.gui_LayoutFcn, gui_SingletonOpt);

        % make figure invisible here so that the visibility of figure is
        % consistent in OpeningFcn in the exported GUI case
        if isempty(gui_VisibleInput)
            gui_VisibleInput = get(gui_hFigure,'Visible');
        end
        set(gui_hFigure,'Visible','off')

        % openfig (called by local_openfig below) does this for guis without
        % the LayoutFcn. Be sure to do it here so guis show up on screen.
        movegui(gui_hFigure,'onscreen');
    else
        gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        % If the figure has InGUIInitialization it was not completely created
        % on the last pass.  Delete this handle and try again.
        if isappdata(gui_hFigure, 'InGUIInitialization')
            delete(gui_hFigure);
            gui_hFigure = local_openfig(gui_State.gui_Name, gui_SingletonOpt, gui_Visible);
        end
    end
    if isappdata(0, genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]))
        rmappdata(0,genvarname(['OpenGuiWhenRunning_', gui_State.gui_Name]));
    end

    % Set flag to indicate starting GUI initialization
    setappdata(gui_hFigure,'InGUIInitialization',1);

    % Fetch GUIDE Application options
    gui_Options = getappdata(gui_hFigure,'GUIDEOptions');
    % Singleton setting in the GUI M-file takes priority if different
    gui_Options.singleton = gui_State.gui_Singleton;

    if ~isappdata(gui_hFigure,'GUIOnScreen')
        % Adjust background color
%         if gui_Options.syscolorfig
%             set(gui_hFigure,'Color', get(0,'DefaultUicontrolBackgroundColor'));
%         end

        % Generate HANDLES structure and store with GUIDATA. If there is
        % user set GUI data already, keep that also.
        data = guidata(gui_hFigure);
        handles = guihandles(gui_hFigure);
        if ~isempty(handles)
            if isempty(data)
                data = handles;
            else
                names = fieldnames(handles);
                for k=1:length(names)
                    data.(char(names(k)))=handles.(char(names(k)));
                end
            end
        end
        guidata(gui_hFigure, data);
    end

    % Apply input P/V pairs other than 'visible'
    for index=1:2:length(varargin)
        if length(varargin) == index || ~ischar(varargin{index})
            break;
        end

        len1 = min(length('visible'),length(varargin{index}));
        if ~strncmpi(varargin{index},'visible',len1)
            try set(gui_hFigure, varargin{index}, varargin{index+1}), catch break, end
        end
    end

    % If handle visibility is set to 'callback', turn it on until finished
    % with OpeningFcn
    gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
    if strcmp(gui_HandleVisibility, 'callback')
        set(gui_hFigure,'HandleVisibility', 'on');
    end

    feval(gui_State.gui_OpeningFcn, gui_hFigure, [], guidata(gui_hFigure), varargin{:});

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        % Handle the default callbacks of predefined toolbar tools in this
        % GUI, if any
        guidemfile('restoreToolbarToolPredefinedCallback',gui_hFigure); 
        
        % Update handle visibility
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);

        % Call openfig again to pick up the saved visibility or apply the
        % one passed in from the P/V pairs
        if ~gui_Exported
            gui_hFigure = local_openfig(gui_State.gui_Name, 'reuse',gui_Visible);
        elseif ~isempty(gui_VisibleInput)
            set(gui_hFigure,'Visible',gui_VisibleInput);
        end
        if strcmpi(get(gui_hFigure, 'Visible'), 'on')
            figure(gui_hFigure);
            
            if gui_Options.singleton
                setappdata(gui_hFigure,'GUIOnScreen', 1);
            end
        end

        % Done with GUI initialization
        if isappdata(gui_hFigure,'InGUIInitialization')
            rmappdata(gui_hFigure,'InGUIInitialization');
        end

        % If handle visibility is set to 'callback', turn it on until
        % finished with OutputFcn
        gui_HandleVisibility = get(gui_hFigure,'HandleVisibility');
        if strcmp(gui_HandleVisibility, 'callback')
            set(gui_hFigure,'HandleVisibility', 'on');
        end
        gui_Handles = guidata(gui_hFigure);
    else
        gui_Handles = [];
    end

    if nargout
        [varargout{1:nargout}] = feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    else
        feval(gui_State.gui_OutputFcn, gui_hFigure, [], gui_Handles);
    end

    if isscalar(gui_hFigure) && ishghandle(gui_hFigure)
        set(gui_hFigure,'HandleVisibility', gui_HandleVisibility);
    end
end

function gui_hFigure = local_openfig(name, singleton, visible)

% openfig with three arguments was new from R13. Try to call that first, if
% failed, try the old openfig.
if nargin('openfig') == 2
    % OPENFIG did not accept 3rd input argument until R13,
    % toggle default figure visible to prevent the figure
    % from showing up too soon.
    gui_OldDefaultVisible = get(0,'defaultFigureVisible');
    set(0,'defaultFigureVisible','off');
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton);
    set(0,'defaultFigureVisible',gui_OldDefaultVisible);
else
    % Call version of openfig that accepts 'auto' option"
    gui_hFigure = matlab.hg.internal.openfigLegacy(name, singleton, visible);  
%     %workaround for CreateFcn not called to create ActiveX
%     if feature('HGUsingMATLABClasses')
%         peers=findobj(findall(allchild(gui_hFigure)),'type','uicontrol','style','text');    
%         for i=1:length(peers)
%             if isappdata(peers(i),'Control')
%                 actxproxy(peers(i));
%             end            
%         end
%     end
end

function result = local_isInvokeActiveXCallback(gui_State, varargin)

try
    result = ispc && iscom(varargin{1}) ...
             && isequal(varargin{1},gcbo);
catch
    result = false;
end

function result = local_isInvokeHGCallback(gui_State, varargin)

try
    fhandle = functions(gui_State.gui_Callback);
    result = ~isempty(findstr(gui_State.gui_Name,fhandle.file)) || ...
             (ischar(varargin{1}) ...
             && isequal(ishghandle(varargin{2}), 1) ...
             && (~isempty(strfind(varargin{1},[get(varargin{2}, 'Tag'), '_'])) || ...
                ~isempty(strfind(varargin{1}, '_CreateFcn'))) );
catch
    result = false;
end